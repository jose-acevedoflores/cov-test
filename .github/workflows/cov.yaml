name: Coverage

on: [push, pull_request]
jobs:
 test-coverage-source-based:
   runs-on: windows-latest
   steps:
#     - uses: actions-rs/cargo@v1
#       name: Install grcov
#       with:
#         command: install
#         args: grcov
     - run: rustup component add llvm-tools-preview
       name: Install llvm tools
     - name: Cache
       id: rust-cache
       uses: actions/cache@v3
       with:
         path: ./target/
         key: lock-${{ hashFiles('**/Cargo.lock') }}
     - uses: actions/checkout@v2
#     - uses: actions-rs/cargo@v1
#       name: Clean
#       with:
#         command: clean
     - uses: actions-rs/cargo@v1
       name: Build
       with:
         command: build
         args: -p client
       env:
         RUSTFLAGS: '-Cinstrument-coverage'
     - uses: actions-rs/cargo@v1
       name: Test
       with:
         command: test
         args: --verbose -p client
       env:
         RUSTFLAGS: '-Cinstrument-coverage'
         LLVM_PROFILE_FILE: 'wut-%p.profraw'
#     - name: Generate Coverage report
#       run: ./bin-cache/bin/grcov
#       run: grcov . -s . --binary-path .\target\debug\ -t lcov --branch --ignore-not-existing -o .\target\lcov.info
#     - run: rustup override unset
#         if: {{ always() }}
